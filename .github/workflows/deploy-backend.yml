# Name of the workflow, which will appear in the GitHub Actions tab
name: Deploy Backend to Google Cloud Run

# This section defines when the workflow should run
on:
  # Trigger the workflow on push events
  push:
    # Only for pushes to the 'main' branch
    branches:
      - main
    # And only when files inside the 'backend/' folder are changed
    paths:
      - 'backend/**'

# Environment variables available to all jobs in this workflow
env:
  PROJECT_ID: skillsphere-live
  GAR_LOCATION: asia-south1 # Google Artifact Registry location
  SERVICE_NAME: skillsphere-backend
  REGION: asia-south1 # Google Cloud Run location

jobs:
  build-and-deploy:
    # The type of virtual machine to run the job on
    runs-on: ubuntu-latest

    steps:
      # Step 1: Check out your repository's code so the workflow can access it
      - name: Checkout repository
        uses: actions/checkout@v4

      # Step 2: Authenticate to Google Cloud using the Service Account Key
      # This is the more reliable method we switched to.
      - name: Authenticate to Google Cloud
        uses: 'google-github-actions/auth@v2'
        with:
          credentials_json: '${{ secrets.GCP_SA_KEY }}' # Use the JSON key secret you created in GitHub

      # Step 3: Set up the Google Cloud SDK in the runner
      - name: Set up Cloud SDK
        uses: 'google-github-actions/setup-gcloud@v2'

      # Step 4: Configure Docker to authenticate with Google Artifact Registry
      - name: Configure Docker
        run: gcloud auth configure-docker ${{ env.GAR_LOCATION }}-docker.pkg.dev --quiet

      # Step 5: Build the Docker image and tag it with a unique identifier (the commit SHA)
      - name: Build and Push Docker image
        run: |
          docker build -t ${{ env.GAR_LOCATION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/skillsphere-images/${{ env.SERVICE_NAME }}:${{ github.sha }} ./backend
          docker push ${{ env.GAR_LOCATION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/skillsphere-images/${{ env.SERVICE_NAME }}:${{ github.sha }}

      # Step 6: Deploy the newly pushed image to Google Cloud Run
      # This also specifies which service account the deployed container should run as
      - name: Deploy to Cloud Run
        run: |
          gcloud run deploy ${{ env.SERVICE_NAME }} \
            --image=${{ env.GAR_LOCATION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/skillsphere-images/${{ env.SERVICE_NAME }}:${{ github.sha }} \
            --region=${{ env.REGION }} \
            --service-account=skillsphere-runner@${{ env.PROJECT_ID }}.iam.gserviceaccount.com \
            --allow-unauthenticated

